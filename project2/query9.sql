WITH TOP10 
AS 
    (SELECT Sa.dept, SUM(Sa.WeeklySales/St.size) AS totalNormSale, RANK() OVER(ORDER BY SUM(Sa.WeeklySales/St.size) DESC) AS rank
    FROM Sales Sa, Stores St
    WHERE Sa.store = St.store
    GROUP BY dept
    LIMIT 10),
MONTH_SALE(Store, dept, WeeklySales, month, year) 
AS 
    (SELECT sa.Store,sa.dept, sa.WeeklySales, SUBSTRING(CAST(WeekDate AS varchar(10)),6,2) AS month, SUBSTRING(CAST(WeekDate AS varchar(10)),0,5) AS year
	FROM Sales sa, Stores st
	WHERE sa.Store = st.Store
	),
MONTH_SALE_SUM 
AS 
	(SELECT store, dept, month, SUM(WeeklySales) AS MONTH_SUM, year
	FROM MONTH_SALE
	GROUP BY month, store, dept, year
	ORDER BY store, year, month
),
monthSaleByDept(dept, yr, mo, monthlysales) 
AS
    (SELECT m.dept, year, month, SUM(MONTH_SUM) AS monthlysales
    FROM MONTH_SALE_SUM m, TOP10 t
    WHERE m.dept = t.dept
    GROUP BY m.dept, year, month
    ORDER BY m.dept, year, month
    )

SELECT *, ROUND(CAST (100 * monthlysales/SUM(monthlysales) OVER(PARTITION BY dept) AS NUMERIC), 2) AS contribution,
ROUND(CAST(SUM(monthlysales) OVER(PARTITION BY dept rows BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS NUMERIC), 2) AS cumulative_sales   
FROM monthSaleByDept;

/*
result:
 dept |  yr  | mo | monthlysales | contribution | cumulative_sales
------+------+----+--------------+--------------+------------------
    2 | 2010 | 02 |  7.65827e+06 |         2.73 |       7658270.00
    2 | 2010 | 03 |  7.54055e+06 |         2.69 |      15198800.00
    2 | 2010 | 04 |  9.65966e+06 |         3.44 |      24858500.00
    2 | 2010 | 05 |  7.75584e+06 |         2.76 |      32614300.00
    2 | 2010 | 06 |  8.02598e+06 |         2.86 |      40640300.00
    2 | 2010 | 07 |  1.02526e+07 |         3.65 |      50893000.00
    2 | 2010 | 08 |   8.4787e+06 |         3.02 |      59371700.00
    2 | 2010 | 09 |  7.87961e+06 |         2.81 |      67251300.00
    2 | 2010 | 10 |  9.30877e+06 |         3.32 |      76560000.00
    2 | 2010 | 11 |  7.34734e+06 |         2.62 |      83907400.00
    2 | 2010 | 12 |  1.01456e+07 |         3.62 |      94052900.00
    2 | 2011 | 01 |  6.95842e+06 |         2.48 |     101011000.00
    2 | 2011 | 02 |  7.67793e+06 |         2.74 |     108689000.00
    2 | 2011 | 03 |   7.7278e+06 |         2.75 |     116417000.00
    2 | 2011 | 04 |  9.48167e+06 |         3.38 |     125899000.00
    2 | 2011 | 05 |  7.57876e+06 |         2.70 |     133478000.00
    2 | 2011 | 06 |  7.87535e+06 |         2.81 |     141353000.00
    2 | 2011 | 07 |   1.0047e+07 |         3.58 |     151400000.00
    2 | 2011 | 08 |  8.36834e+06 |         2.98 |     159768000.00
    2 | 2011 | 09 |  9.68926e+06 |         3.45 |     169458000.00
    2 | 2011 | 10 |  7.57475e+06 |         2.70 |     177032000.00
    2 | 2011 | 11 |  7.61872e+06 |         2.72 |     184651000.00
    2 | 2011 | 12 |  1.09072e+07 |         3.89 |     195558000.00
    2 | 2012 | 01 |   7.3865e+06 |         2.63 |     202945000.00
    2 | 2012 | 02 |  8.05679e+06 |         2.87 |     211001000.00
    2 | 2012 | 03 |  9.90513e+06 |         3.53 |     220907000.00
    2 | 2012 | 04 |  7.82793e+06 |         2.79 |     228735000.00
    2 | 2012 | 05 |  7.82149e+06 |         2.79 |     236556000.00
    2 | 2012 | 06 |  1.01336e+07 |         3.61 |     246690000.00
    2 | 2012 | 07 |  8.09828e+06 |         2.89 |     254788000.00
    2 | 2012 | 08 |  1.04932e+07 |         3.74 |     265281000.00
    2 | 2012 | 09 |  7.73551e+06 |         2.76 |     273017000.00
    2 | 2012 | 10 |  7.59459e+06 |         2.71 |     280611000.00
   13 | 2010 | 02 |  5.64529e+06 |         2.86 |       5645290.00
    ...
   95 | 2010 | 07 |  1.70078e+07 |         3.79 |      83749400.00
   95 | 2010 | 08 |  1.33169e+07 |         2.96 |      97066300.00
   95 | 2010 | 09 |  1.26549e+07 |         2.82 |     109721000.00
   95 | 2010 | 10 |  1.46903e+07 |         3.27 |     124412000.00
   95 | 2010 | 11 |  1.12816e+07 |         2.51 |     135693000.00
   95 | 2010 | 12 |  1.41653e+07 |         3.15 |     149858000.00
   95 | 2011 | 01 |  1.12333e+07 |         2.50 |     161092000.00
   95 | 2011 | 02 |  1.19164e+07 |         2.65 |     173008000.00
   95 | 2011 | 03 |  1.20414e+07 |         2.68 |     185050000.00
   95 | 2011 | 04 |  1.48977e+07 |         3.32 |     199947000.00
   95 | 2011 | 05 |  1.26394e+07 |         2.81 |     212587000.00
   95 | 2011 | 06 |  1.36431e+07 |         3.04 |     226230000.00
   95 | 2011 | 07 |  1.70495e+07 |         3.79 |     243279000.00
   95 | 2011 | 08 |  1.36392e+07 |         3.04 |     256919000.00
   95 | 2011 | 09 |  1.57936e+07 |         3.52 |     272712000.00
   95 | 2011 | 10 |  1.23242e+07 |         2.74 |     285036000.00
   95 | 2011 | 11 |   1.1769e+07 |         2.62 |     296805000.00
   95 | 2011 | 12 |   1.4623e+07 |         3.25 |     311428000.00
   95 | 2012 | 01 |  1.17186e+07 |         2.61 |     323147000.00
   95 | 2012 | 02 |   1.2146e+07 |         2.70 |     335293000.00
   95 | 2012 | 03 |  1.54477e+07 |         3.44 |     350741000.00
   95 | 2012 | 04 |  1.27086e+07 |         2.83 |     363449000.00
   95 | 2012 | 05 |  1.32109e+07 |         2.94 |     376660000.00
   95 | 2012 | 06 |  1.71354e+07 |         3.81 |     393796000.00
   95 | 2012 | 07 |  1.37155e+07 |         3.05 |     407511000.00
   95 | 2012 | 08 |  1.67642e+07 |         3.73 |     424275000.00
   95 | 2012 | 09 |  1.27289e+07 |         2.83 |     437004000.00
   95 | 2012 | 10 |   1.2316e+07 |         2.74 |     449320000.00
(330 rows)
*/